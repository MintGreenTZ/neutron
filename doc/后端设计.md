# 后端设计

## 简述

后端对于数据的存储主要分为五个部分。一是对用户信息的存储，包括。。。。；二是对列车信息的存储，包括两个顺序存储文件，三是对站点和火车ID分别建的hash表；四是每个站点建立一个bitset，记录每辆火车是否经过这个站点；五是用户购买车票的信息，用一棵bptree存储。

​	

### 一、用户：

##### 

### 二、车次：

我们将车次的主要信息存在一个顺序表中，检索这列火车以hash值trainID_h为关键字，由一个顺序表管理系统插入和检索。

```c++
class trainData {
	str<20> loc, priceName[5], trainID;
	str<40> name;
    str<10> catalog;
	stopInfo stop[60];
	short numStation, numPrice, trainID_h;
	bool saled;
}
```
其中stopInfo类记录一站的信息，记录站点名称的hash值loc，起始到站和中转时间t[3]，价格的前缀和sumPrice[5]。

```c++
class stopInfo {
	short loc, t[3];
	int sumPrice[5];
};
```

此外车票剩余数量单独采用一个顺序表存储，因为只有一辆列车sale过后我们才会关心它的车票数，所以sale后才加入这个顺序表。由于列车途经站的长度不会修改，我们以不定长存储以节省空间，并且将其中一部分读进内存，方便买票退票时快速修改。



## 三、hash表

对站名和trainID建立hash表，使得传输和存储只需要一个short，以及方便建立bptree时采用整型关键词和方便关键词复合。hash表中采用线性探查。



## 四、bitset

为了实现快速查询车次操作，我们建立了一组bitset，对于每个站点建立一棵bitset，记录每列火车是否经过它。当查询直达时，将起始站的bitset作&操作，在得到的bitset中枚举列车，检查是否可行。在查询中转时，枚举中间站点，在起始站-中转站和中转站-终点站分别用查询直达操作，另外记录时间取最小值。



## 五、车票

我们将车票信息存储在一棵bptree中，以userID，date，trainID，起点站start，终点站stop复合成一个unsigned long long作为key，以输出所必要的信息作为value。查询时，某一个用户在某一天买的车票在这样设计的关键词下是连续的，所以可以在bptree上顺序查找。

```C++
struct ticketData {
	str<10> catalog;
	int price[5];
	short numPrice, num[5], start, end, startTime, endTime, date;
	str<20> priceName[5];
}
```

